<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DualPay Calculator</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@400;600;700&family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'deep-sea': '#0B3D91', // Наситено морско синьо
                        'bg-light': '#9D50BB', // Светло лилаво
                        'bg-dark': '#6E48AA',  // Тъмно лилаво
                        'input-blue': '#E3F2FD', // Синьо за полетата
                    },
                    fontFamily: {
                        'comfortaa': ['Comfortaa', 'cursive'],
                        'montserrat': ['Montserrat', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Styles & Animations */
        body {
            overflow: hidden; /* Prevent scrolling on background */
            background: linear-gradient(135deg, #9D50BB, #4A00E0);
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Montserrat', sans-serif;
        }

        /* Glassmorphism Container */
        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
        }

        /* Background Animation Layer */
        #bg-animation {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
            display: grid;
            grid-template-columns: repeat(6, 1fr); /* Grid for checkerboard feel */
        }

        .floating-symbol {
            color: rgba(255, 255, 255, 0.25); /* Ясно открояващи се, но не пречещи */
            font-family: 'Comfortaa', cursive;
            font-weight: bold;
            font-size: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: floatAnim 8s ease-in-out infinite;
            user-select: none;
        }

        @keyframes floatAnim {
            0% { transform: translate(0, 0) rotate(0deg) scale(1); }
            33% { transform: translate(10px, -15px) rotate(10deg) scale(1.1); }
            66% { transform: translate(-5px, 10px) rotate(-5deg) scale(0.95); }
            100% { transform: translate(0, 0) rotate(0deg) scale(1); }
        }

        /* Inputs cleanup */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="text-gray-800">

    <div id="bg-animation"></div>

    <div class="glass-panel w-full max-w-md h-[95vh] sm:h-auto sm:max-h-[90vh] sm:rounded-3xl flex flex-col relative overflow-hidden transition-all duration-300">
        
        <header class="pt-6 pb-4 px-6 flex flex-col items-center justify-center shrink-0">
            <div class="bg-deep-sea text-white p-3 rounded-2xl shadow-lg mb-2 flex items-center justify-center space-x-2">
                <span class="font-comfortaa text-2xl font-bold">€</span>
                <span class="text-xl">⇄</span>
                <span class="font-comfortaa text-2xl font-bold">лв</span>
            </div>
            <h1 class="font-comfortaa text-deep-sea text-xl font-bold tracking-wide">DualPay Calculator</h1>
        </header>

        <main class="flex-1 overflow-y-auto px-6 pb-6 space-y-5">
            
            <div class="space-y-2">
                <label class="font-comfortaa text-sm font-bold text-gray-600 ml-1">Сума за плащане</label>
                <div class="flex rounded-xl overflow-hidden shadow-inner border border-blue-200">
                    <input type="number" id="inputTotal" inputmode="decimal" placeholder="0.00" 
                        class="w-2/3 bg-input-blue p-4 text-2xl font-montserrat font-bold text-deep-sea outline-none placeholder-blue-300">
                    <button id="toggleCurrency" class="w-1/3 bg-deep-sea text-white font-comfortaa font-bold text-lg hover:bg-opacity-90 transition-colors">
                        BGN
                    </button>
                </div>
            </div>

            <hr class="border-gray-300/50">

            <div class="grid grid-cols-2 gap-4">
                <div class="space-y-1">
                    <label class="font-comfortaa text-xs font-bold text-gray-500 ml-1">Платено в лв</label>
                    <input type="number" id="paidBGN" inputmode="decimal" placeholder="0.00" 
                        class="w-full bg-white/80 p-3 rounded-xl border border-gray-200 text-xl font-montserrat font-bold text-gray-700 focus:ring-2 focus:ring-deep-sea outline-none shadow-sm">
                </div>
                <div class="space-y-1">
                    <label class="font-comfortaa text-xs font-bold text-gray-500 ml-1">Платено в €</label>
                    <input type="number" id="paidEUR" inputmode="decimal" placeholder="0.00" 
                        class="w-full bg-white/80 p-3 rounded-xl border border-gray-200 text-xl font-montserrat font-bold text-gray-700 focus:ring-2 focus:ring-deep-sea outline-none shadow-sm">
                </div>
            </div>

            <div id="errorBox" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-3 rounded shadow-sm fade-in">
                <p class="font-comfortaa text-sm font-bold">Недостатъчна сума!</p>
                <p class="text-xs font-montserrat" id="errorText">Остават още: 0.00 лв</p>
            </div>

            <div id="resultBox" class="hidden fade-in bg-white/60 p-4 rounded-2xl shadow-md border border-white space-y-3">
                <div class="flex justify-between items-center mb-1">
                    <span class="font-comfortaa text-deep-sea font-bold text-lg">Ресто</span>
                    <div class="flex bg-gray-200 rounded-lg p-1">
                        <button id="resBtnBGN" class="px-3 py-1 rounded-md text-xs font-bold font-comfortaa bg-white shadow text-deep-sea transition-all">BGN</button>
                        <button id="resBtnEUR" class="px-3 py-1 rounded-md text-xs font-bold font-comfortaa text-gray-500 hover:text-deep-sea transition-all">EUR</button>
                    </div>
                </div>
                
                <div class="text-center">
                    <div id="mainChange" class="text-4xl font-montserrat font-bold text-deep-sea tracking-tight">0.00 <span class="text-2xl">лв</span></div>
                    <div id="secChange" class="text-sm font-montserrat font-medium text-gray-500 mt-1">(= 0.00 €)</div>
                </div>
            </div>

        </main>

        <footer class="bg-deep-sea/10 backdrop-blur-sm py-3 px-6 text-center border-t border-white/20 shrink-0">
            <p class="text-xs font-montserrat font-bold text-deep-sea">Курс: 1 EUR = 1.95583 BGN</p>
            <p class="text-[10px] font-comfortaa text-gray-600 mt-1">© Никол Пункова</p>
        </footer>
    </div>

    <script>
        // --- 1. CONFIGURATION ---
        const RATE = 1.95583;
        let totalCurrency = 'BGN'; // 'BGN' or 'EUR'
        let resultCurrency = 'BGN'; // 'BGN' or 'EUR'

        // --- 2. PWA SETUP (Manifest & SW) ---
        function setupPWA() {
            // A. Create Dynamic Icon
            const canvas = document.createElement('canvas');
            canvas.width = 512;
            canvas.height = 512;
            const ctx = canvas.getContext('2d');
            
            // Background
            ctx.fillStyle = '#0B3D91'; // Deep Sea Blue
            ctx.beginPath();
            ctx.roundRect(0, 0, 512, 512, 100);
            ctx.fill();
            
            // Text
            ctx.fillStyle = '#FFFFFF';
            ctx.font = 'bold 180px Comfortaa';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('€⇄лв', 256, 256);

            const iconUrl = canvas.toDataURL('image/png');
            
            // Set Favicon
            const linkIcon = document.createElement('link');
            linkIcon.rel = 'icon';
            linkIcon.href = iconUrl;
            document.head.appendChild(linkIcon);
            
            const linkApple = document.createElement('link');
            linkApple.rel = 'apple-touch-icon';
            linkApple.href = iconUrl;
            document.head.appendChild(linkApple);

            // B. Create Manifest
            const manifest = {
                name: "DualPay Calculator",
                short_name: "DualPay",
                start_url: ".",
                display: "standalone",
                background_color: "#6E48AA",
                theme_color: "#0B3D91",
                icons: [{ src: iconUrl, sizes: "512x512", type: "image/png" }]
            };
            const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/manifest+json'});
            const manifestUrl = URL.createObjectURL(manifestBlob);
            const linkManifest = document.createElement('link');
            linkManifest.rel = 'manifest';
            linkManifest.href = manifestUrl;
            document.head.appendChild(linkManifest);

            // C. Service Worker (Offline capability)
            if ('serviceWorker' in navigator) {
                const swCode = `
                    self.addEventListener('install', e => self.skipWaiting());
                    self.addEventListener('fetch', e => e.respondWith(fetch(e.request).catch(() => new Response('Offline'))));
                `;
                const swBlob = new Blob([swCode], {type: 'application/javascript'});
                const swUrl = URL.createObjectURL(swBlob);
                navigator.serviceWorker.register(swUrl).catch(console.error);
            }
        }

        // --- 3. UI GENERATION (Background) ---
        function createBackground() {
            const container = document.getElementById('bg-animation');
            const symbols = ['€', 'лв'];
            const count = 30; // Number of symbols

            for (let i = 0; i < count; i++) {
                const el = document.createElement('div');
                el.classList.add('floating-symbol');
                // Strict alternating
                el.innerText = symbols[i % 2];
                
                // Random animation properties for organic feel
                el.style.animationDelay = `${Math.random() * 5}s`;
                el.style.animationDuration = `${6 + Math.random() * 6}s`;
                el.style.opacity = `${0.1 + Math.random() * 0.3}`; // Random visibility
                
                container.appendChild(el);
            }
        }

        // --- 4. CALCULATOR LOGIC ---
        const ui = {
            total: document.getElementById('inputTotal'),
            toggleCurr: document.getElementById('toggleCurrency'),
            paidBGN: document.getElementById('paidBGN'),
            paidEUR: document.getElementById('paidEUR'),
            errorBox: document.getElementById('errorBox'),
            errorText: document.getElementById('errorText'),
            resultBox: document.getElementById('resultBox'),
            mainChange: document.getElementById('mainChange'),
            secChange: document.getElementById('secChange'),
            btnResBGN: document.getElementById('resBtnBGN'),
            btnResEUR: document.getElementById('resBtnEUR'),
        };

        function calculate() {
            const totalVal = parseFloat(ui.total.value) || 0;
            const paidBGNVal = parseFloat(ui.paidBGN.value) || 0;
            const paidEURVal = parseFloat(ui.paidEUR.value) || 0;

            if (totalVal === 0) {
                ui.resultBox.classList.add('hidden');
                ui.errorBox.classList.add('hidden');
                return;
            }

            // Normalize everything to BGN for calculation
            let totalInBGN = (totalCurrency === 'BGN') ? totalVal : (totalVal * RATE);
            let paidInBGN = paidBGNVal + (paidEURVal * RATE);
            let changeInBGN = paidInBGN - totalInBGN;

            // Handle Error (Insufficient Funds)
            if (changeInBGN < -0.009) { // Small epsilon for float errors
                ui.errorBox.classList.remove('hidden');
                ui.resultBox.classList.add('hidden');
                let missingBGN = Math.abs(changeInBGN);
                let missingEUR = missingBGN / RATE;
                
                if (totalCurrency === 'BGN') {
                    ui.errorText.textContent = `Остават още: ${missingBGN.toFixed(2)} лв`;
                } else {
                    ui.errorText.textContent = `Остават още: ${missingEUR.toFixed(2)} €`;
                }
                return;
            }

            // Success (Show Change)
            ui.errorBox.classList.add('hidden');
            ui.resultBox.classList.remove('hidden');

            renderResult(changeInBGN);
        }

        function renderResult(changeInBGN) {
            let mainAmount, mainSym, secAmount, secSym;
            let changeInEUR = changeInBGN / RATE;

            if (resultCurrency === 'BGN') {
                mainAmount = changeInBGN.toFixed(2);
                mainSym = 'лв';
                secAmount = changeInEUR.toFixed(2);
                secSym = '€';
            } else {
                mainAmount = changeInEUR.toFixed(2);
                mainSym = '€';
                secAmount = changeInBGN.toFixed(2);
                secSym = 'лв';
            }

            ui.mainChange.innerHTML = `${mainAmount} <span class="text-2xl">${mainSym}</span>`;
            ui.secChange.textContent = `(= ${secAmount} ${secSym})`;
        }

        // --- 5. EVENT LISTENERS ---
        
        // Input Toggle
        ui.toggleCurr.addEventListener('click', () => {
            totalCurrency = (totalCurrency === 'BGN') ? 'EUR' : 'BGN';
            ui.toggleCurr.textContent = totalCurrency;
            calculate();
        });

        // Result Toggles
        ui.btnResBGN.addEventListener('click', () => {
            resultCurrency = 'BGN';
            updateResultToggleStyles();
            calculate();
        });

        ui.btnResEUR.addEventListener('click', () => {
            resultCurrency = 'EUR';
            updateResultToggleStyles();
            calculate();
        });

        function updateResultToggleStyles() {
            if (resultCurrency === 'BGN') {
                ui.btnResBGN.className = "px-3 py-1 rounded-md text-xs font-bold font-comfortaa bg-white shadow text-deep-sea transition-all";
                ui.btnResEUR.className = "px-3 py-1 rounded-md text-xs font-bold font-comfortaa text-gray-500 hover:text-deep-sea transition-all";
            } else {
                ui.btnResEUR.className = "px-3 py-1 rounded-md text-xs font-bold font-comfortaa bg-white shadow text-deep-sea transition-all";
                ui.btnResBGN.className = "px-3 py-1 rounded-md text-xs font-bold font-comfortaa text-gray-500 hover:text-deep-sea transition-all";
            }
        }

        // Calculation Triggers
        ['input', 'change', 'keyup'].forEach(evt => {
            ui.total.addEventListener(evt, calculate);
            ui.paidBGN.addEventListener(evt, calculate);
            ui.paidEUR.addEventListener(evt, calculate);
        });

        // Initialize
        window.addEventListener('load', () => {
            setupPWA();
            createBackground();
            updateResultToggleStyles();
        });

    </script>
</body>
</html>
